digraph second {
size="30,40";
_main [shape=ellipse,label="Second stage"];
node [shape=box];
_main->start [label="데이터 부분 점프"];
start [label="EBDA를 제외한\n640KB 영역 끝에\n복사한다"];
start->init_bss;
init_bss [label="BSS 0으로 초기화"];
init_bss->continue [label="복사한 코드로 점프"];
continue [label="serial 초기화\nserial로 \"LI\"출력\n이제 serial도 같이 출력"];
continue->drkbd
drkbd [label="키보드 버퍼 비움"]; // 32회
drkbd->comcom;
comcom [label="\"L\" 출력"];
comcom->int_1e;
int_1e [label="INT 0x1E의\n섹터수가 9보다 큰가?",shape=diamond];
int_1e->dskok [label="Yes"];
int_1e->patch_1e [label="No",style=dotted];
patch_1e [label="섹터수를 18로 패치"];
patch_1e->dskok [style=dotted];
dskok [label="timeout 핸들러 설치"];
dskok->restrt;
restrt [label="Second와 0x90000\n사이에 32KB 공간이 있는가?",shape=diamond]
restrt->initseg_9000 [label="Yes"];
restrt->initseg_8xxx [label="No",style=dotted];
initseg_9000 [label="커널을\n0x90000에 위치"];
initseg_8xxx [label="커널을\nSecond-32KB에 위치"];
initseg_9000->restrt1;
initseg_8xxx->restrt1 [style=dotted];
restrt1 [label="SETUP=커널시작+1섹터\nStack=Second아래"];
restrt1->restrt_ver;
restrt_ver [label="문자열(LILO,MAGE)\n스테이지(2),버전(23.2) 체크",shape=diamond];
restrt_ver->crshbrn [label="wrong",style=dotted];
restrt_ver->crsh_ok [label="OK"];
crshbrn [label="\"signature not found\" 출력"];
crshbrn->zzz [style=dotted];
zzz [label="halt 무한루프"];
crsh_ok [label="부팅된 하드와\n저장된 하드가 다른가?",shape=diamond];
crsh_ok->ldsc [label="같다"]
crsh_ok->devmap_ax [label="다르다",style=dotted]
devmap_ax [label="볼륨 테이블에 추가"];
devmap_ax->ldsc [style=dotted];
ldsc [label="First와 Second의\n map 생성시간이 같은가?",shape=diamond]
ldsc->call_kt_read [label="Yes"];
ldsc->timeerr [label="No",style=dotted];
timeerr [label="\"O - Timestamp mismatch\" 출력"];
timeerr->zzz [style=dotted];
call_kt_read [label="키보드 테이블 섹터를 읽는다.\n(Menutable 포함)"];
call_kt_read->call_build_vol_tab;
call_build_vol_tab [label="Volume table 생성."];
call_build_vol_tab->descr_more;
descr_more [label="디스크립터\n섹터들을 읽는다."];
descr_more->ldsc [label="error",style=dotted];
descr_more->descr_crc;
descr_crc [label="CRC32 체크",shape=diamond];
descr_crc->timeerr [label="error\n메세지\n버그",style=dotted];
descr_crc->nochkerr [label="OK"];
nochkerr [shape=diamond,label="vmware가\n동작중인가?"] 
nochkerr->virtual_done [label="No"];
nochkerr->vir_loop [label="Yes",style=dotted];
vir_loop [label="VMDISABLE\n디스크립터 삭제"];
vir_loop->virtual_done [style=dotted];
virtual_done [label="키보드가\n연결되었는가?",shape=diamond];
//virtual_done->kbd_done [label="Yes"];
virtual_done->ldfl [label="Yes"];
virtual_done->kbd_loop [label="No",style=dotted];
kbd_loop [label="NOKBDISABLE\n디스크립터 삭제"];
kbd_loop->ldfl [style=dotted];
//kbd_loop->kbd_done [style=dotted];
//kbd_done [label="OR(menutable플래그,First플래그)"];
//kbd_done->ldfl
ldfl [label="Default command line\n섹터를 읽는다."];
ldfl->ldsc [label="error",style=dotted];
ldfl->dc_magic [label="OK"];
dc_magic [label="lock된\nDefault command line이\n있는가?",shape=diamond];
dc_magic->bdcmag [label="No"];
dc_magic->call_cmd_write [label="Yes"];
call_cmd_write [label="lock 매직넘버 없애고\n디스크에 기록"];
call_cmd_write->dokay;
bdcmag [label="Default command line\n초기화"];
bdcmag->dokay;
dokay [label="\"O 23.2 \" 출력"];
dokay->reset_hma;
reset_hma  [label="메모리크기=0\n분기점=대화식처리"];
reset_hma->call_kbtest;
call_kbtest [label="키보드 또는 시리얼이\n연결중?",shape=diamond];
call_kbtest->kbd_present [label="Yes"];
call_kbtest->skip_prompt [label="No",style=dotted];
kbd_present [label="프롬프트\n입력 사용?",shape=diamond];
kbd_present->skip_prompt;
kbd_present->extp [label="On"];
skip_prompt [label="분기점=\n첫이미지로 부팅"];
skip_prompt->call_waitsh;
call_waitsh [label="키가 눌렸거나\nbreak signal이 왔는가?",shape=diamond];
call_waitsh->iloop [label="Yes"];
call_waitsh->extp [label="No"];
extp [label="external\nparameter 사용?",shape=diamond];
extp->noex [label="No"];
extp->extp_cl [label="Yes"];
extp_cl->yes_extp;
extp_cl [label="external parameter의\n커맨드라인 버퍼 사용"];
{rank=same;extp_cl noex};
yes_extp [label="external parameter 적용\nsignature 확인"];
yes_extp->empty_extp_cl;
empty_extp_cl [label="external parameter\ncommand line 값이 있는가?"];
empty_extp_cl->iloop [label="No"];
empty_extp_cl->niloop [label="Yes"];
noex [label="Default command line\n버퍼 사용"];
noex->noex_cmp;
noex_cmp [label="버퍼에 내용이\n있는가?",shape=diamond];
noex_cmp->niloop [label="Yes"];
noex_cmp->jmp_ax [label="No"];
jmp_ax [label="분기점으로 점프"];
jmp_ax->iloop [label="대화식 처리"];
jmp_ax->bfirst [label="첫\n이미지로\n 부팅"];
iloop [label="메세지가\n있는가?",shape=diamond];
iloop->greeting [label="Yes"];
iloop->nomsg [label="No/이미 출력"];
greeting [label="greeting 메세지를\n 읽어서 출력"];
greeting->nomsg;
nomsg [label="커널 파라미터=\n\"auto BOOT_IMAGE...\"\n키입력 사용"];
nomsg->niloop;
{rank=same;niloop iloop nomsg};
niloop [label="\"boot: \" 출력"];
niloop->clend;
clend [label="옵션 버퍼\n내용 출력"];
clend->input;
//clend->cledne;
//cledne [label="\"BOOT_IMAGE\"에 \" \" 추가"];
//cledne->input;
input [label="키입력\n사용?",shape=diamond];
{rank=same;kbinp fetch_si}
input->kbinp [label="Yes"];
input->fetch_si [label="No"];
fetch_si [label="키입력대신\n버퍼에 있는\n 문자를 넘긴다."]; // si++
fetch_si->gotinp;
kbinp [label="키입력을 받는다."];
kbinp->brfrst [label="시간 초과",style=dotted];
kbinp->noNull;
noNull [label="입력값이\nNUL인가?",shape=diamond];
noNull->gotinp [label="No"];
noNull->input [label="Yes\n키입력 NUL\n은 무시",style=dotted];
gotinp [label="입력받은 키값이나\n넘어온 문자값",shape=diamond];
gotinp->tolist [label="TAB\n?"];
gotinp->nul [label="NUL"]; // end of process
gotinp->todelch [label="BS\nDEL"]; // BS
gotinp->input [label="X<32\nX>127\n무시",style=dotted]; // <32 >127
gotinp->todell [label="^U\n^X"]; // erase the line
gotinp->noblnk [label="32<X<127\n"];
gotinp->dup_blnk [label="Space"];
gotinp->cr [label="Enter"];
tolist [label="이미지들 출력"];
tolist->iloop;
nul [label="키입력이\n있는가?",shape=diamond];
nul->crnul [label="No"]
nul->msg_int [label="Yes",style=dotted]
msg_int [label="\"Interrupted\" 출력"];
msg_int->iloop;
todelch [label="한글자\n삭제"];
todelch->input;
todell [label="버퍼\n삭제"];
todell->input;
dup_blnk [label="Space가 중복인가?"];
dup_blnk->input [label="Yes",style=dotted];
dup_blnk->noblnk [label="No"]
noblnk [label="버퍼크기\n초과?",shape=diamond];
noblnk->input [label="Yes"];
noblnk->savechar [label="No"];
savechar [label="받은 문자\n옵션 버퍼에 저장\n/화면에 출력"];
savechar->sklp;
sklp [label="위치가 처음이고\n일치하는 single-key\n이미지가 있는가?",shape=diamond];
sklp->input [label="No"];
sklp->cr [label="Yes"];
cr [label="커널 파라미터=\n\"BOOT_IMAGE...\""];
cr->crnul;
crnul [label="locking 사용안함"];
crnul->cpsav;
cpsav [label="입력받은 버퍼에서\n커널로 넘길 버퍼로 복사"];
cpsav->empty_inp;
empty_inp [label="버퍼끝이\n공백인가?",shape=diamond];
empty_inp->notrspc [label="No"];
empty_inp->rm_empty [label="Yes"];
rm_empty [label="버퍼끝\n공백 제거"];
rm_empty->notrspc
notrspc [label="읽는버퍼와 쓰는버퍼를\n동일하게 설정"];
notrspc->chkvga;
chkvga [label="\"nobd\" &\n다음글자<=32 ?",shape=diamond];
chkvga->vsktv [label="No"];
chkvga->do_nobd [label="Yes"];
do_nobd [label="BIOS data\n수집하지 않는다."];
do_nobd->vskwd;
vsktv [label="\"vga=\" ?",shape=diamond];
vsktv->call_setvga [label="Yes"];
vsktv->vsktk [label="No"];
call_setvga [label="\"vga=\" 수치\n 해석후 저장"]; // vgaovr
call_setvga->iloop [label="error",style=dotted];
call_setvga->vskdb;
vsktk [label="\"kbd=\" ?",shape=diamond];
vsktk->vsktl [label="No"];
vsktk->call_putkbd [label="Yes"];
call_putkbd [label="\"kbd=\"다음\n키코드를 키버퍼에\n넣는다."];
call_putkbd->vskdb;
vsktl [label="\"lock \" ?",shape=diamond];
vsktl->vsktm [label="No"];
vsktl->vsktl_lock [label="Yes"];
vsktl_lock [label="locking 사용"];
vsktl_lock->vskwd;
vskwd [label="다음 옵션"];
vskwd->vskdb;
vskdb [label="쓰는위치 1감소"];
vskdb->vsknb;
vsktm [label="\"mem=\" ?",shape=diamond];
vsktm->vsknb [label="No"];
vsktm->vsktm_getmem [label="Yes"];
vsktm_getmem [label="메모리\n크기 설정"];
vsktm_getmem->vsknb;
vsknb [label="문자 복사"];
vsknb->vsknb_sp;
vsknb_sp [label="문자가\n공백인가?",shape=diamond];
vsknb_sp->chkvga [label="Yes",style=dotted];
vsknb_sp->vsknb_nul [label="No"];
vsknb_nul [label="버퍼\n끝인가?",shape=diamond];
vsknb_nul->vsknb [label="No"];
vsknb_nul->vsknb_crlf [label="Yes"];
vsknb_crlf [label="CR/LF 출력"];
vsknb_crlf->emptyl;
emptyl [label="복사한 것이\n있는가?",shape=diamond];
emptyl->bfirst [label="No"];
emptyl->bcmd [label="Yes"];
bcmd [label="일치하는\n이미지가 있는가?",shape=diamond];
bcmd->boot [label="Yes"];
bcmd->bcmd_msg [label="No",style=dotted];
bcmd_msg [label="\"No such image.\n[Tab] shows a list.\" 출력"];
bcmd_msg->iloop [style=dotted];
bfirst [label="옵션 버퍼에\n내용이 있는가?",shape=diamond];
bfirst->bcmd [label="Yes"];
bfirst->brfrst [label="No"];
brfrst [label="처음 플래그가\n일치하는 이미지로 세팅"];
brfrst->bfcpl;
bfcpl [label="cmdline에\n이름 복사"];
bfcpl->boot;
boot [label="timeout 중지"];
boot->locopt;
locopt [label="옵션 포인터 저장"];
locopt->optfnd;
optfnd [label="VM경고를 사용하고\nVMWARE에서 동작중?",shape=diamond];
optfnd->boot9 [label="No"];
optfnd->optfnd_vmwarn [label="Yes"];
optfnd_vmwarn [label="Virtual boot\n경고 출력 [Y/N]"];
optfnd_vmwarn->optfnd_getkey 
optfnd_getkey [label="키입력을\n받는다.",shape=diamond];
optfnd_getkey->optfnd_crlf [label="32미만"];
optfnd_getkey->optfnd_disp [label="32이상"];
optfnd_disp [label="입력받은\n문자 출력"];
optfnd_disp->optfnd_crlf;
optfnd_crlf [label="CR/LF 출력"];
optfnd_crlf->boot3;
boot3 [label="y or Y ?",shape=diamond];
boot3->boot9 [label="Yes"];
boot3->iloop [label="No\n시간초과"];
boot9 [label="패스워드\n사용?"];
boot9->doboot [label="No"];
boot9->dopw [label="Yes"];
dopw [label="\"Password: \" 출력\n계산할 공간 확보"];
dopw->pwloop;
pwloop [label="키입력을\n받는다"];
pwloop->pwinp;
pwinp [label="키 입력값"];
pwinp->pwcr [label="Enter"];
pwinp->pwdell [label="^U\n^X"];
pwinp->pwdelch [label="BS\nDEL"];
pwinp->pwloop [label="X<32\nX>127\n(출력불가)\noverflow"];
pwinp->pwdisp [label="32<X<127"];
pwdisp [label="\"*\" 출력\n버퍼에 password 저장"];
pwdisp->pwloop;
pwdelch [label="한글자 삭제"];
pwdelch->pwloop;
pwdell [label="모두 삭제"];
pwdell->pwloop;
pwcr [label="CR/LF 출력"];
pwcr->pwtime;
pwtime [label="password의\nSHA 해시를\n 구한다."];
pwtime->pwcleanup;
pwcleanup [label="메모리 상의\n패드워드 삭제"];
pwcleanup->pwchk;
pwchk [label="해시값\n일치?"];
pwchk->pwfail [label="No",style=dotted];
pwchk->doboot [label="Yes"];
pwfail [label="\"Sorry.\" 출력"];
pwfail->iloop [style=dotted];
doboot [label="\"Loading <이미지 이름>\" 출력\nfallback을 읽어들인다"];
doboot->doboot_gdt;
doboot_gdt [label="GDT 초기화"];
doboot_gdt-> dclok
dclok [label="fallback이\n있는가?",shape=diamond];
dclok->dclok_write [label="Yes"];
dclok->nofbck [label="No"];
dclok_write [label="fallback을\ndefault command line\n섹터에 쓴다."];
dclok_write->nofbck;
nofbck [label="(auto) BOOT_IMAGE=이름,\n옵션섹터,cmdline옵션부를\nParmline에 복사"];
nofbck->cpdone;
cpdone [label="파라미터에\nvga값 저장\ninitseg에 bootsect 로드"];
cpdone->novga 
novga [label="locking\n사용?",shape=diamond];
novga->lockit [label="Yes"];
novga->lsetup [label="No"];
lockit [label="리로옵션 제외하고\ndefault command line\n섹터에 쓴다."];
lockit->lsetup;
lsetup [label="setup 영역이\nsecond를 침범하는가?"];
lsetup->lsetup_msg [label="Yes"];
lsetup->enough_mem [label="No"];
lsetup_msg [label="\"EBDA is big...\" 출력"];
lsetup_msg->enough_mem;
enough_mem [label="setup코드를\n읽어들인다."];
enough_mem->launch [label="EOF",style=dotted];
enough_mem->lsloop;
lsloop [label="big kernel\n인가?",shape=diamond];
lsloop->loadlow [label="No"];
lsloop->ls_loadhi [label="Yes"];
ls_loadhi [label="1M 위쪽에\n로드하는가?",shape=diamond];
ls_loadhi->ls_gdt [label="Yes"];
ls_loadhi->nohigh [label="No"];
ls_gdt [label="로드할곳(GDT)=\n1M(0x100000)"];
ls_gdt->nohigh;
nohigh [label="커널의 BOOT\nProtocol 버전이\n2.01 이상인가?",shape=diamond];
nohigh->yes_heap [label="Yes"];
nohigh->noheap [label="No"];
yes_heap [label="second영역을\nheap으로 설정"];
yes_heap->noheap;
noheap [label="initrd를 읽어온다.\n공백 출력"];
noheap->chklow 
chklow [label="GDT 설정이\n되어있는가?",shape=diamond];
chklow->loadlow [label="No"];
chklow->loadhigh [label="Yes"];
loadhigh [label="0x100000에\n커널 로드"];
loadhigh->launch;
loadlow [label="0x10000에\n커널 로드"];
loadlow->launch;
launch [label="CD boot\nemulation 중지"];
launch->not_el_torito;
not_el_torito [label="CR/LF 출력\nfloppy 모터 중지"];
not_el_torito->IsHdrS;
IsHdrS [label="커널 signature\n(\"HdrS\")이 맞는가?",shape=diamond];
IsHdrS->mbchain [label="No"];
IsHdrS->chkver [label="Yes"];
mbchain [label="체인로더 헤더가\n 일치하는가?",shape=diamond];
mbchain->not_chain [label="No"];
mbchain->mbmap [label="Yes"];
mbmap [label="매핑된 드라이브값 저장\ndevmap 포인터 저장"];
mbmap->not_chain;
not_chain [label="dx=first에서 저장된\n드라이브값"];
not_chain->start_setup2;
chkver [label="커널 주소보다\ninitrd 주소가 낮은가?",shape=diamond];
chkver->msg_confl [label="Yes"];
chkver->no_overwrite [label="No"];
msg_confl [label="\"Kernel and Initrd\nmemory conflict\" 출력"];
msg_confl->zzz;
no_overwrite [label="BOOT PROTOCOL\n버전 2.02 이상?"];
no_overwrite->above_202 [label="Yes"];
no_overwrite->protocol201 [label="No"];
above_202 [label="new command line\n에 파라미터 전달"];
above_202->start_setup;
protocol201 [label="구버전 주소에\n매직넘버와 파라미터 전달"];
protocol201->start_setup;
start_setup [label="\"BIOS data check \" 출력"];
start_setup->start_chknobd;
start_chknobd [label="BIOD data\n수집하는가 ?"];
start_chknobd->msg_by [label="No"];
start_chknobd->start_setup3 [label="Yes"];
msg_by [label="\"bypassed\" 출력"];
msg_by->start_setup2;
start_setup3 [label="BIOS data\n수집/저장"];
start_setup3->start_setup2;
start_setup2 [label="1.5초 대기"];
start_setup2->call_remto;
call_remto [label="timer 핸들러 제거"];
call_remto->jmp_setup;
jmp_setup [label="Setup code",shape=ellipse];


}
